@model PeriodViewModel

@{
    ViewData["Title"] = "Отчет на служител";
}

@{ var TaskList = new List<int>();}
@{ var dateList = new HashSet<DateTime>();}
@{ int hours = 1;}
@{ int sum = 0;}

<div class="PrimeBox2 widthmobile" style="max-width:100%; position:relative; background-color:ghostwhite; margin-top:10px !important">
    <div class="form-group row" style="background-color: #69a0f1; display: flex; justify-content: center;  align-items: center;" id="container">
        <h5 style="color:white; margin-left:15px;">Периодичен отчет на @(Model.PersonalDateList.FullName)</h5>
        @*<button asp-controller="Tasks" asp-action="TasksList" id="x">
                X
            </button>*@
    </div>
    <div>
        <table class="table table-striped table-bordered compact" style="width:100%">
            <thead style="display:table; width:100%; table-layout:fixed; width:calc( 100% - 1em );">
                <tr>
                    <th style="min-width:29px; max-width:30px;">Дата</th>
                    @foreach (var item in Model.PersonalDateList.WorkedHoursByTaskByPeriod)
                    {
                        if (!TaskList.Contains(item.TaskId))
                        {
                            TaskList.Add(item.TaskId);
                            <th style="min-width:30px;">@(item.TaskName.Length > 60 ? (item.TaskName).Substring(0, 60) + "..." : item.TaskName)</th>
                        }

                        if (!dateList.Contains(item.WorkDate.Date))
                        {
                            dateList.Add(item.WorkDate.Date);
                        }
                    }
                    <th>Общо</th>
                </tr>
            </thead>
            <tbody style="display: block; height: 500px; overflow: auto;">

                @foreach (var worckedDate in dateList)
                {
                    sum = 0;
                    <tr style=" display: table; width: 100%; table-layout: fixed; /* even columns width , fix width of table too*/ ">
                        <td>@worckedDate.Date.ToString("dd/MM/yyyy")</td>
                        @foreach (var id in TaskList)
                        {
                            hours = Model.PersonalDateList.WorkedHoursByTaskByPeriod.Where(wh => wh.TaskId == id && wh.WorkDate.Date == worckedDate.Date).Select(wh => wh.HoursSpend).FirstOrDefault();
                            sum = sum + hours;
                           <td>@(hours > 0 ? hours.ToString() : "")</td>
                        }
                        <td style="background-color:ivory; font-size:medium;"><strong>@sum</strong></td>
                    </tr>
                }
                <tr style="background-color:ivory; font-size:medium; display: table; width: 100%; table-layout: fixed;">
                    <td>Общо:</td>
                    @{sum = 0; }
                    @foreach (var id in TaskList)
                    {
                        hours = Model.PersonalDateList.WorkedHoursByTaskByPeriod.Where(wh => wh.TaskId == id).Sum(wh => wh.HoursSpend);
                        <td><strong>@hours</strong></td>
                        sum += hours;
                    }
                    <td><strong>@sum</strong></td>
                </tr>
            </tbody>
        </table>
        <form method="get" asp-action="ExportSpravkaForEmployee" asp-controller="Report">
            <input asp-for="userId" class="form-control" hidden />
            <input asp-for="StartDate" class="form-control" nopicker="true" hidden />
            <input asp-for="EndDate" class="form-control" nopicker="true" hidden />
            <input type="submit" class="btn button save" value="Експорт в Ексел" id="realsend" />
            @*<a class="button btncansel" style="margin-left:15px;" asp-action="TasksList" asp-controller="Tasks">
                Списък задачи
            </a>*@
        </form>

    </div>
</div>